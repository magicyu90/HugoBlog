---
title: 直播（一）
date: 2019-02-17 19:31:29
tags: [直播]
categories: 直播
---

这几年，随着直播业的发展，直播相关的技术（视频推送、编解码、直播协议等）也越来越热。关于直播业务大体上包括三个主要部分：**设备视频采集和推送**、**流媒体服务器接收和转发**、**客户端播放视频**，每部分涉及的知识也很多，所接触到的协议也很多。

<!-- more -->

利用春节假期时间研究了些直播、视频推送相关的技术，今天打算总结一下。

---

### 直播流程一：采集
简单地说，直播业务首先从采集开始，设备上（摄像头、手机等）从系统中（以API方式调用设备接口）获取原始视频数据，视频数据包括**音频数据**和**图像数据**。音频数据通过设备将环境中的模拟信号采集成PCM编码数据，PCM 脉冲编码调制是Pulse Code Modulation的缩写，主要将语音、图像等模拟信号实现数字化的脉冲编码调制技术。然后压缩成对应的压缩格式数据并分发，如MP3、AAC、FLAC等都属于音频压缩格式。

音频采集阶段，主要技术参数有：
* 采样率（samplerate）：采样就是把模拟信号数字化的过程，采样频率越高，记录这一段音频信号所用的数据量就越大，同时音频质量也就越高。在ffmpeg中我们通过-ar参数来设置采样率，采样率的单位是赫兹(Hz)。
* 位宽：每一个采样点都需要用一个数值来表示大小，这个数值的数据类型大小可以是：4bit、8bit、16bit、32bit 等等，位数越多，表示得就越精细，声音质量自然就越好，而数据量也会成倍增大。我们在音频采样过程中常用的位宽是 8bit 或者 16bit。
* 声道数（channels）：由于音频的采集和播放是可以叠加的，因此，可以同时从多个音频源采集声音，并分别输出到不同的扬声器，故声道数一般表示声音录制时的音源数量或回放时相应的扬声器数量。声道数为 1 和 2 分别称为单声道和双声道，是比较常见的声道参数。ffmpeg中通过-ac channel设置声道数，1：单声道，2：立体声。
* 音频帧（frame）：音频数据是流式的，本身没有明确的一帧帧的概念，在实际的应用中，为了音频算法处理/传输的方便，一般约定俗成取2.5ms~60ms 为单位的数据量为一帧音频。这个时间被称之为“采样时间”，其长度没有特别的标准，它是根据编解码器和具体应用的需求来决定的。

图像采集即采集的图片结果组合成一组连续播放的动画。由于人体眼睛具有视觉暂留现象，也就是说当我们看到一样东西，它就算消失了，我们的视神经对物体的印象不会立即消失，要延续0.1 -0.4秒的时间它才会真正消失，由于上述特性才会有视频存在。图像的采集过程主要由摄像头等设备拍摄成 YUV 颜色编码格式的原始数据，然后经过编码压缩成 H.264 等格式的数据分发出去。常见的视频封装格式有：MP4、3GP、AVI、MKV、WMV、MPG、VOB、FLV、SWF、MOV、RMVB 和 WebM 等。视频压缩算法包括：M-JPEG、Mpeg、H.264、H.265、Wavelet（小波压缩）、JPEG 2000、AVS等。

图像采集参数，主要有：
* 分辨率：随着设备屏幕尺寸的日益增多，视频采集过程中原始视频分辨率起着越来越重要的作用，后续处理环节中使用的所有视频分辨率的定义都以原始视频分辨率为基础。视频采集卡能支持的最大点阵反映了其分辨率的性能。
* 采样频率：采样频率反映了采集卡处理图像的速度和能力。在进行高度图像采集时，需要注意采集卡的采样频率是否满足要求。采样率越高，图像质量越高，同时保存这些图像信息的数据量也越大。


### 如何采集?
#### 1. 摄像头采集
比如大华、海康厂商的监控摄像头，这些摄像头配合厂商提供的APP（海康萤石云视频等）进行监控，当然这些摄像头也会提供对应监控RTSP地址。对于手机来说，业界有些技术和SDK支持摄像头的采集。这里以Android为例，罗列可用的技术方案。Android端推流方案大体包括两大类：1. 利用FFmpeg进行直播推流 2. 利用开源项目和SDK
* [EasyPusher RTSP推流SDK](https://github.com/EasyDarwin/EasyPusher)：支持RTSP
* [EasyRTMP-Android](https://github.com/EasyDSS/EasyRTMP-Android)
* [七牛播放端SDK](https://developer.qiniu.com/pili/sdk/1210/the-android-client-sdk)
* [MediaCodec做直播推流](https://www.jianshu.com/p/3c479c0f4876):需使用LibRtmp将视频数据封成RTMP包
* [Yasea直播推流](https://www.jianshu.com/p/3c479c0f4876):效率高、延迟低


#### 2. 视频文件推流
比如使用ffmpeg软件将一个视频或音频文件以直播流（RTMP、RTSP）的形式推送。

---
### 直播流程二：流媒体服务器接受和转发
流媒体服务器是流媒体应用的核心系统，主要功能是对流媒体内容采集、存储和转发，并以流式协议（RTSP、RTMP)将视频文件传输到客户端（Web、PC、手机等）。这里不得不提下大名鼎鼎的Adobe公司及其Flash播放器（Flash的装机量以达到99%以上），直播常用到的RTMP协议即为Adobe公司为Flash和服务器间数据传输所开发的协议，如果想使用RTMP做直播的话，前提需要安装并打开Flash。但是关于Flash的诟病（兼容性、后续支持）也是不少的。

常见的流媒体服务器有：
* [Red5流媒体服务器](https://github.com/Red5/red5-server)
* [EasyDarwin服务器](https://github.com/EasyDarwin/EasyDarwin)
* [nginx+rtmp_module](https://github.com/arut/nginx-rtmp-module)
* [Live555流媒体](https://github.com/rgaufman/live555)
* [EasyDSS流媒体服务器](https://github.com/EasyDSS/EasyDSS)
* [Wowza流媒体](https://github.com/wowzamediasystems)


### 参考资料
------
* [视频直播技术详解」系列之一：采集](https://zhuanlan.zhihu.com/p/22502905)